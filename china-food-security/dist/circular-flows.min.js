!function(a){a.countrymerge=function(a,b){return a.regions.reduce(function(c,d,e){if(b.indexOf(d)===-1)c.push(d);else for(var f=d+1;f<(a.regions[e+1]||a.names.length);f++)c.push(f);return c},[])}}("undefined"!=typeof exports&&exports||window.Globalmigration||(window.Globalmigration={})),function(a){var b=Math.PI,c=b/180,d=180/b;a.layout=function(){function e(a){for(var b=0,c=0;c<j.regions.length&&!(j.regions[c]>a);c++)b=c;return j.regions[b]}function f(){var a,c,d,f,m,s={},w=[],x=d3.range(o),y=[];for(j=j||{matrix:{},names:[],regions:[]},n=n||Object.keys(j.matrix)[0],k=n&&j.matrix[n]||[],h=[],i=[],a=0,f=-1;++f<o;){for(c=0,m=-1;++m<o;)c+=k[l[f]][l[m]],c+=k[l[m]][l[f]];w.push(c),y.push({source:d3.range(o),target:d3.range(o)}),a+=c}for(p&&x.sort(function(a,b){return p(w[a],w[b])}),q&&y.forEach(function(a,b){a.source.sort(function(a,c){return q(k[l[b]][l[a]],k[l[b]][l[c]])}),a.target.sort(function(a,c){return q(k[l[a]][l[b]],k[l[c]][l[b]])})}),a=(2*b-u*o)/a,c=t.alpha(),f=-1;++f<o;){var z=0,A=0,B=x[f];for(d=c,m=-1;++m<o;){var C=y[B].target[m],D=k[l[C]][l[B]],E=c,F=D*a;c+=F,s["target-"+B+"-"+C]={originalIndex:l[C],index:B,subindex:C,startAngle:E,dAngle:D*a,value:D},z+=D}var G=d;for(d=c,m=-1;++m<o;){var C=y[B].source[m],D=k[l[B]][l[C]],E=c,F=D*a;c+=F,s["source-"+B+"-"+C]={originalIndex:l[B],index:B,subindex:C,startAngle:E,dAngle:D*a,value:D},A+=D}i[B]={id:l[B],region:e(l[B]),index:B,startAngle:G,endAngle:c,angle:G+(c-G)/2,inflow:z,outflow:A,value:Math.round((c-G)/a)},c+=u}for(f=-1;++f<o;)for(m=f-1;++m<o;){var H=s["source-"+f+"-"+m],I=s["target-"+m+"-"+f];if(f===m){if(null===v||H.value>v){var I=s["target-"+f+"-"+m];h.push({id:"source-"+l[f]+"-"+l[m],source:{id:l[H.index],region:e(l[H.index]),index:H.index,subindex:H.subindex,startAngle:H.startAngle,endAngle:H.startAngle+H.dAngle,value:H.value},target:{id:l[I.index],region:e(l[I.index]),index:I.index,subindex:I.subindex,startAngle:I.startAngle,endAngle:I.startAngle+I.dAngle,value:I.value}})}}else{(null===v||H.value>v)&&h.push({id:"source-"+l[f]+"-"+l[m],source:{id:l[H.index],region:e(l[H.index]),index:H.index,subindex:H.subindex,startAngle:H.startAngle,endAngle:H.startAngle+H.dAngle,value:H.value},target:{id:l[I.index],region:e(l[I.index]),index:I.index,subindex:I.subindex,startAngle:I.startAngle,endAngle:I.startAngle+I.dAngle,value:I.value}});var H=s["source-"+m+"-"+f],I=s["target-"+f+"-"+m];(null===v||H.value>v)&&h.push({id:"target-"+l[f]+"-"+l[m],source:{id:l[H.index],region:e(l[H.index]),index:H.index,subindex:H.subindex,startAngle:H.startAngle,endAngle:H.startAngle+H.dAngle,value:H.value},target:{id:l[I.index],region:e(l[I.index]),index:I.index,subindex:I.subindex,startAngle:I.startAngle,endAngle:I.startAngle+I.dAngle,value:I.value}})}}r&&g()}function g(){h.sort(function(a,b){return r(a.source.value,b.source.value)})}var h,i,j,k,l,m,n,o,p,q,r,s,t={},u=0,v=null;return t.data=function(a){return arguments.length?(j=a,l=j.regions.slice(),o=l.length,h=i=null,t):j},t.year=function(a){return arguments.length?(n=a,h=i=null,t):n},t.countries=function(b){return arguments.length?(m=b,l=a.countrymerge(j,m),o=l.length,h=i=null,t):m},t.padding=function(a){return arguments.length?(u=a,h=i=null,t):u},t.threshold=function(a){return arguments.length?(v=a,h=i=null,t):v},t.sortGroups=function(a){return arguments.length?(p=a,h=i=null,t):p},t.sortSubgroups=function(a){return arguments.length?(q=a,h=null,t):q},t.sortChords=function(a){return arguments.length?(r=a,h&&g(),t):r},t.chords=function(){return h||f(),h},t.groups=function(){return i||f(),i},t.alpha=function(a){return arguments.length?(s=0===a?1e-5:a,s*=c,s=s.mod(2*b),h=i=null,t):s*d},Number.prototype.mod=function(a){return(this%a+a)%a},t}}(window.Globalmigration||(window.Globalmigration={})),function(a){function b(a){return a.source}function c(a){return a.target}function d(a){return a.startAngle}function e(a){return a.endAngle}function f(a){return a.radius}function g(a){return a.targetPadding}function h(a){return a.sourcePadding}var i=d3.functor,j=Math.PI,k=-j/2;a.chord=function(){function a(a,b){var c=m(this,q,a,b),d=m(this,r,a,b,!0);n(c,d)&&(c.a1=c.a1-(c.a1-c.a0)/2,c.p1=[c.r*Math.cos(c.a1),c.r*Math.sin(c.a1)],d.a0=d.a0+(d.a1-d.a0)/2,d.p0=[d.r*Math.cos(d.a0),d.r*Math.sin(d.a0)]);var e=l(c,d,.618*c.r);return"M"+c.p0+o(c.r,c.p1,c.a1-c.a0)+p(e.cps1,e.cpt0,d.p0)+o(d.r,d.p1,d.a1-d.a0)+p(e.cpt1,e.cps0,c.p0)+"Z"}function l(a,b,c){return cps0=[c*Math.cos(a.a0),c*Math.sin(a.a0)],cps1=[c*Math.cos(a.a1),c*Math.sin(a.a1)],cpt0=[c*Math.cos(b.a0),c*Math.sin(b.a0)],cpt1=[c*Math.cos(b.a1),c*Math.sin(b.a1)],{cps0:cps0,cps1:cps1,cpt0:cpt0,cpt1:cpt1}}function m(a,b,c,d,e){var f=b.call(a,c,d),g=s.call(a,f,d),h=v.call(a,f,d)+k,i=w.call(a,f,d)+k;if(e){var c=u.call(a,f,d)||0;g-=c}else{var c=t.call(a,f,d)||0;g-=c}return{r:g,a0:h,a1:i,p0:[g*Math.cos(h),g*Math.sin(h)],p1:[g*Math.cos(i),g*Math.sin(i)]}}function n(a,b){return a.a0==b.a0&&a.a1==b.a1}function o(a,b,c){return"A"+a+","+a+" 0 "+ +(c>j)+",1 "+b}function p(a,b,c){return"C "+a+" "+b+" "+c}var q=b,r=c,s=f,t=h,u=g,v=d,w=e;return a.radius=function(b){return arguments.length?(s=i(b),a):s},a.sourcePadding=function(b){return arguments.length?(t=i(b),a):t},a.targetPadding=function(b){return arguments.length?(u=i(b),a):u},a.source=function(b){return arguments.length?(q=i(b),a):q},a.target=function(b){return arguments.length?(r=i(b),a):r},a.startAngle=function(b){return arguments.length?(v=i(b),a):v},a.endAngle=function(b){return arguments.length?(w=i(b),a):w},a}}(window.Globalmigration||(window.Globalmigration={})),function(a){a.timeline=function(a,b){var c=Object.keys(a.data.matrix).map(function(a){return parseInt(a)});b=b||{},b.element=b.element||"body",b.now=b.now||c[0],b.incr=b.incr||5;var d=d3.select(b.element).append("form"),e=d.selectAll(".year").data(c),f=e.enter().append("span").classed("year",!0);f.append("input").attr({name:"year",type:"radio",id:function(a){return"year-"+a},value:function(a){return a},checked:function(a){return a===b.now||null}}).on("click",function(b){var c=b;e.selectAll("input").attr("checked",function(a){return c===a||null}),a.draw(b)}),f.append("label").attr("for",function(a){return"year-"+a}).text(function(a){return""+a+(1===b.incr?"":"-"+(a+b.incr))}),d3.select(document.body).on("keypress",function(){var a=d3.event.which-49,b=c[a];b&&e.selectAll("input").each(function(a){a===b&&d3.select(this).on("click")(a)})})}}(window.Globalmigration||(window.Globalmigration={})),function(a){var b=Math.PI;a.chart=function(a,c){function d(a){if(a.region===a.id)return t(a.region);var b=d3.hsl(t(a.region)),c=[b.brighter(.75),b.darker(2),b,b.brighter(1.5),b.darker(1)];return c[(a.id-a.region)%5]}function e(a){return d(a.source)}function f(a){var d=a.mod(2*b);return{x:Math.cos(d-b/2)*c.labelRadius,y:Math.sin(d-b/2)*c.labelRadius,r:180*(d-b/2)/b}}function g(a,b){b=b||",",a+="",x=a.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var c=/(\d+)(\d{3})/;c.test(x1);)x1=x1.replace(c,"$1"+b+"$2");return x1+x2}function h(a){var b=d3.rgb(a);return.21*b.r+.71*b.g+.07*b.b}function i(b){var d=this;H&&clearTimeout(H);var e=d.getBBox();H=setTimeout(function(){var c=d3.select(d).style("fill");G.attr("transform","translate("+(e.x+e.width/2)+","+(e.y+e.height/2)+")");var f=G.select(".text").selectAll("text").data([a.names[b.id],"Total In: "+g(b.inflow),"Total Out: "+g(b.outflow)]);f.enter().append("text"),f.text(function(a){return a}).style({fill:h(c)>160?"black":"white"}).attr({transform:function(a,b){return"translate(6, "+(14*b+16)+")"}}),f.exit().remove();var i=G.select(".text").node().getBBox();G.select("rect").style("fill",c).attr({width:i.width+12,height:i.height+10}),G.transition().attr("opacity",1)},c.infoPopupDelay)}function j(b){var d=this;H&&clearTimeout(H);var e=d.getBBox();H=setTimeout(function(){var c=d3.select(d).style("fill");G.attr("transform","translate("+(e.x+e.width/2)+","+(e.y+e.height/2)+")").attr("opacity",0).transition().attr("opacity",1);var f=G.select(".text").selectAll("text").data([a.names[b.source.id]+" â†’ "+a.names[b.target.id]+": "+g(b.source.value)]);f.enter().append("text"),f.exit().remove(),f.text(function(a){return a}).style({fill:h(c)>160?"black":"white"}).attr("transform",function(a,b){return"translate(6, "+(12*b+16)+")"}),G.selectAll("rect").style("fill",d3.select(d).style("fill"));var i=G.select(".text").node().getBBox();G.select("rect").attr({width:i.width+12,height:i.height+10})},c.infoPopupDelay)}function k(){u.groups=z.groups().reduce(function(a,b){return a[b.id]=b,a},{})}function l(){u.chords=z.chords().reduce(function(a,b){return a[b.source.id]=a[b.source.id]||{},a[b.source.id][b.target.id]=b,a},{})}function m(b){var c=a.regions[a.regions.indexOf(b)+1];return{start:b+1,end:c?c-1:a.names.length-1}}function n(a,b){return a>=b.start&&a<=b.end}function o(a,b){return!!b.filter(function(b){return n(a.source.id,b)||n(a.target.id,b)}).length}function p(a){if(a.id===a.region){var b=m(a.id),c=u.groups[b.start],d=u.groups[b.end];if(c&&d)return{angle:c.startAngle+(d.endAngle-c.startAngle)/2,startAngle:c.startAngle,endAngle:d.endAngle}}}function q(a){if(a.source.id===a.source.region){var b={source:{},target:{}};return Object.keys(u.chords).forEach(function(c){Object.keys(u.chords[c]).forEach(function(d){var e=u.chords[c][d];e.source.region===a.source.id&&((!b.source.startAngle||e.source.startAngle<b.source.startAngle)&&(b.source.startAngle=e.source.startAngle),(!b.source.endAngle||e.source.endAngle>b.source.endAngle)&&(b.source.endAngle=e.source.endAngle)),e.target.region===a.target.id&&((!b.target.startAngle||e.target.startAngle<b.target.startAngle)&&(b.target.startAngle=e.target.startAngle),(!b.target.endAngle||e.target.endAngle>b.target.endAngle)&&(b.target.endAngle=e.target.endAngle))})}),b.source.startAngle=b.source.startAngle||0,b.source.endAngle=b.source.endAngle||s,b.target.startAngle=b.target.startAngle||0,b.target.endAngle=b.target.endAngle||s,b.source.endAngle=b.source.startAngle+s,b.target.endAngle=b.target.startAngle+s,b}}function r(g,h){g=g||Object.keys(a.matrix)[0],h=h||u.countries,u.countries=h;var n=h.map(m);k(),l(),z.year(g).countries(h);var t=C.selectAll(".group").data(z.groups,function(a){return a.id});t.enter().append("g").attr("class","group"),t.on("mouseover",function(a){G.classed("fade",function(b){return b.source.id!==a.id&&b.target.id!==a.id})}),t.exit().remove();var x=t.selectAll(".group-arc").data(function(a){return[a]});x.enter().append("path").attr("class","group-arc").attr("id",function(a,b,c){return"group"+c}),x.style("fill",d).on("mousemove",i).transition().duration(c.animationDuration).attrTween("d",function(a){var b=d3.interpolate(u.groups[a.id]||u.groups[a.region]||p(a)||c.initialAngle.arc,a);return function(a){return y(b(a))}}),x.exit().remove(),x.filter(function(a){return a.id===a.region}).on("click",function(a){h.length+1>c.maxRegionsOpen&&h.shift(),r(g,h.concat(a.id))}),x.filter(function(a){return a.id!==a.region}).on("click",function(a){h.splice(h.indexOf(a.region),1),r(g,h)});var B=C.selectAll(".label").data(z.groups,function(a){return a.id});B.enter().append("g").attr("class","label"),B.filter(function(a){return a.id!==a.region}).transition().duration(c.animationDuration).attrTween("transform",function(a){var b=d3.interpolate(u.groups[a.id]||u.groups[a.region]||p(a)||{angle:0},a);return function(a){var a=f(b(a).angle);return"translate("+a.x+" "+a.y+") rotate("+a.r+")"}}),B.exit().transition().duration(c.animationDuration).style("opacity",0).attrTween("transform",function(a){if(a.id!==a.region){var b=z.groups().filter(function(b){return b.id===a.region});b=b&&b[0];var c=b&&b.startAngle+(b.endAngle-b.startAngle)/2;c=c||0;var d=d3.interpolate(a,{angle:c});return function(a){var a=f(d(a).angle);return"translate("+a.x+" "+a.y+") rotate("+a.r+")"}}}).each("end",function(){d3.select(this).remove()});var D=B.selectAll("text").data(function(a){return[a]});D.enter().append("text"),D.classed("region",function(a){return a.id===a.region}).text(function(b){if(b.id!==b.region)return a.names[b.id]}).attr("transform",function(a){if(a.id!==a.region)return a.angle.mod(2*b)>b?"translate(0, -4) rotate(180)":"translate(0, 4)"}).attr("text-anchor",function(a){return a.id===a.region?"middle":a.angle.mod(2*b)>b?"end":"start"}).style("fill",function(a){return a.id===a.region?d(a):null}).classed("fade",function(a){return a.value<c.layout.labelThreshold});var E=t.filter(function(a){return a.id===a.region}).selectAll(".group-textpath-arc").data(function(a){return[a]});E.enter().append("path").attr("class","group-textpath-arc").attr("id",function(a,b,c){return"group-textpath-arc"+a.id}),E.style("fill","none").transition().duration(c.animationDuration).attrTween("d",function(a){var d=d3.interpolate(u.groups[a.id]||u.groups[a.region]||p(a)||c.initialAngle.arc,a);return a.angle.mod(2*b)>b/2&&a.angle.mod(2*b)<3*b/2?function(a){return w(d(a))}:function(a){return v(d(a))}}),E.exit().remove();var F=D.filter(function(a){return a.id===a.region}).selectAll("textPath").data(function(a){return[a]});F.enter().append("textPath"),F.text(function(b){return a.names[b.id]}).attr("startOffset",function(a){return a.angle.mod(2*b)>b/2&&a.angle.mod(2*b)<3*b/2?"75%":"25%"}).attr("xlink:href",function(a,b,c){return"#group-textpath-arc"+a.id}),F.filter(function(a,b){return this.getComputedTextLength()>(a.endAngle-a.startAngle)*(c.outerRadius+18)}).remove();var G=C.selectAll(".chord").data(z.chords,function(a){return a.id});G.enter().append("path").attr("class","chord").on("mousemove",j),G.style("fill",e).transition().duration(c.animationDuration).attrTween("d",function(a){var b=u.chords[a.source.id]&&u.chords[a.source.id][a.target.id];b=b||u.chords[a.source.region]&&u.chords[a.source.region][a.target.region],b=b||q(a),b=b||c.initialAngle.chord;var d=d3.interpolate(b,a);return function(a){return A(d(a))}}),G.exit().transition().duration(c.animationDuration).style("opacity",0).attrTween("d",function(a){var b=d3.interpolate(a,{source:{startAngle:a.source.endAngle-s,endAngle:a.source.endAngle},target:{startAngle:a.target.endAngle-s,endAngle:a.target.endAngle}});return function(a){return A(b(a))}}).each("end",function(){d3.select(this).remove()}),G.classed("unselected",!!n.length&&function(a){return!o(a,n)}),d3.select(window).on("resize.svg-resize")()}a=a||{regions:[],names:[],matrix:[]},c=c||{},c.element=c.element||"body",c.now=c.now||Object.keys(a.matrix)[0],c.width=c.width||1100,c.height=c.height||1100,c.margin=c.margin||125,c.outerRadius=c.outerRadius||Math.min(c.width,c.height)/2-c.margin,c.arcWidth=c.arcWidth||24,c.innerRadius=c.innerRadius||c.outerRadius-c.arcWidth,c.arcPadding=c.arcPadding||.005,c.sourcePadding=c.sourcePadding||3,c.targetPadding=c.targetPadding||20,c.labelPadding=c.labelPadding||10,c.labelRadius=c.labelRadius||c.outerRadius+c.labelPadding;var s=b/1e5;c.animationDuration=c.animationDuration||1e3,c.initialAngle=c.initialAngle||{},c.initialAngle.arc=c.initialAngle.arc||{startAngle:0,endAngle:s},c.initialAngle.chord=c.initialAngle.chord||{source:c.initialAngle.arc,target:c.initialAngle.arc},c.layout=c.layout||{},c.layout.sortSubgroups=c.layout.sortSubgroups||d3.descending,c.layout.sortChords=c.layout.sortChords||d3.descending,c.layout.threshold=c.layout.threshold||1e3,c.layout.labelThreshold=c.layout.labelThreshold||1e5,c.layout.alpha=c.layout.alpha||s,c.maxRegionsOpen=c.maxRegionsOpen||2,c.infoPopupDelay=c.infoPopupDelay||300;var t=d3.scale.category10().domain(a.regions);c.layout.colors&&t.range(c.layout.colors);var u={countries:[]};Number.prototype.mod=function(a){return(this%a+a)%a};var v=d3.svg.arc().innerRadius(c.outerRadius+10).outerRadius(c.outerRadius+10),w=d3.svg.arc().innerRadius(c.outerRadius+18).outerRadius(c.outerRadius+18),y=d3.svg.arc().innerRadius(c.innerRadius).outerRadius(c.outerRadius),z=Globalmigration.layout().padding(c.arcPadding).threshold(c.layout.threshold).data(a).year(c.now);c.layout.sortGroups&&z.sortGroups(c.layout.sortGroups),c.layout.sortSubgroups&&z.sortSubgroups(c.layout.sortSubgroups),c.layout.sortChords&&z.sortChords(c.layout.sortChords),c.layout.alpha&&z.alpha(c.layout.alpha);var A=Globalmigration.chord().radius(c.innerRadius).sourcePadding(c.sourcePadding).targetPadding(c.targetPadding),B=d3.select(c.element).append("svg").attr("preserveAspectRatio","xMidYMid").attr("viewBox","0 0 "+c.width+" "+c.height).attr("width",c.width).attr("height",c.height),C=B.append("g").attr("id","circle").attr("transform","translate("+c.width/2+","+c.height/2+")");d3.select(window).on("resize.svg-resize",function(){var a=B.node().parentNode.clientWidth;a&&a<c.width&&B.attr("height",a)});var D=C.append("circle").attr("r",c.outerRadius+24),E=B.append("filter").attr("id","dropshadow");E.append("feGaussianBlur").attr({in:"SourceAlpha",stdDeviation:2}),E.append("feOffset").attr({dx:0,dy:1,result:"offsetblur"}),E.append("feComponentTransfer").append("feFuncA").attr({type:"linear",slope:.5});var F=E.append("feMerge");F.append("feMergeNode"),F.append("feMergeNode").attr("in","SourceGraphic");var G=B.append("g").attr("class","info-group").attr("transform","translate("+c.width/2+","+c.height/2+")").append("g").attr("class","info").attr("opacity",0);G.append("rect").style("filter","url(#dropshadow)"),G.append("g").attr("class","text"),B.on("mousemove",function(){G.transition().duration(10).attr("opacity",0)}),D.on("mouseout",function(){H&&clearTimeout(H),G.transition().duration(10).attr("opacity",0)});var H;return{draw:r,data:a}}}(window.Globalmigration||(window.Globalmigration={}));