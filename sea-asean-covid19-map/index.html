<!DOCTYPE html>
<html>

<head>
  <title>Covid-19 Cases in Southeast Asia | CSIS Southeast Asia Program</title>

  <meta name="viewport" content="initial-scale=1.0" />
  <meta charset="utf-8" />

  <!-- Include Leaflet -->
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
  <link href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" rel="stylesheet" />

  <!-- Include CARTO.js -->
  <script src="https://libs.cartocdn.com/carto.js/v4.2.0/carto.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" />
  <link href="https://carto.com/developers/carto-js/examples/maps/public/style.css" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="map.css">
</head>

<body>
  <div id="map"></div>

  <!-- Description -->
  <aside class="toolbox">
    <section class="box">
      <header>
        <h1>COVID-19 Totals</h1>
      </header>
      <section>
        <p class="description open-sans">
          Hover over the
          interactive map to learn more detail about each country.
        </p>
        <p class="description open-sans">
          Use the buttons below to view the number of total confirmed COVID-19
          cases and total confirmed deaths from COVID-19.
        </p>
        <div class="button-container">
          <button class="btn active" id="total-cases-button">Total Cases</button>
          <button class="btn" id="total-deaths-button">Total Deaths</button>
        </div>
        <ul class="legend">
          <li id="small">10</li>
          <li id="medium">1,000</li>
          <li id="large">>10,000</li>
        </ul>
      </section>
      <footer class="js-footer"></footer>
  </aside>

  <script>
    // Variable declaration and initial assignment
    let totalCasesOpacity = 1;
    let totalDeathsOpacity = 0;

    // Create Leaflet Map
    const map = L.map("map").setView([10, 110], 5);
    map.scrollWheelZoom.disable();

    // Create separate pane in Leaflet and set zIndex to bring it to
    // the front, while telling it to ignore pointerEvents so it doesn't
    // mistake user actions as clicking on country labels
    map.createPane("labels");
    map.getPane("labels").style.zIndex = 650;
    map.getPane("labels").style.pointerEvents = "none";

    // Add basemap of countries with no labels from Mapbox using
    // Third Party CARTO Integration URL
    L.tileLayer(
      "https://api.mapbox.com/styles/v1/ilabmedia/ck909nhog00nz1iqp7gximt6s/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiaWxhYm1lZGlhIiwiYSI6ImNpbHYycXZ2bTAxajZ1c2tzdWU1b3gydnYifQ.AHxl8pPZsjsqoz95-604nw",
      {
        maxZoom: 18,
      }
    ).addTo(map);

    // Add basemap of *only* country labels from Mapbox using Third
    // Party CARTO Integration URL. Specify pane as 'labels' so above
    // getPane will take effect, putting labels on top of everything else
    L.tileLayer(
      "https://api.mapbox.com/styles/v1/ilabmedia/ck8rn1khs0k691inz8zh0ejdd/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiaWxhYm1lZGlhIiwiYSI6ImNpbHYycXZ2bTAxajZ1c2tzdWU1b3gydnYifQ.AHxl8pPZsjsqoz95-604nw",
      {
        maxZoom: 18,
        pane: "labels",
      }
    ).addTo(map);

    //Update footer to attribute the program
    map.attributionControl.addAttribution('<a href="https://www.csis.org/programs/southeast-asia-program">CSIS Southeast Asia Program</a>')

    // Defining a carto.Client, the entry point to CARTO.js which
    // handles communication between app and CARTO account
    const client = new carto.Client({
      apiKey: "5QG-UzbQNxyNreqAyYCckw",
      username: "csis",
    });

    // Define carto.source.Dataset to use the sea_covid19_tracker_map dataset
    const dataSource = new carto.source.SQL(`
      SELECT *
      FROM map_data_coronavirus_covid19_cases_in_sea
    `);

    // Style the total_cases data
    let dataStyle = new carto.style.CartoCSS(`
      #layer {
        marker-width: ramp([total_cases], range(10, 150), equal(500));
        marker-fill: #0064a3;
        marker-fill-opacity: 0.6;
        marker-allow-overlap: true;
        marker-line-width: 1;
        marker-line-color: #025488;
        marker-line-opacity: 1;
      }
    `);

    function setTotalCasesStyle(totalCasesOpacity) {
      totalCasesStyle.setContent(`
          #layer {
            polygon-fill: ramp([total_cases], (#b5e6ff, #99cbec, #7cb0da, #5e96c8, #3d7db6, #0065a4), quantiles);
            polygon-opacity: ${totalCasesOpacity};
          }
          #layer::outline {
            line-width: 1;
            line-color: #FFFFFF;
            line-opacity: 0.5;
          }
        `);
    }

    // Combine total_cases source and style
    const totalCases = new carto.layer.Layer(
      dataSource,
      dataStyle, {
      featureOverColumns: ['country', 'total_cases', 'total_deaths']
    }
    );

    const totalCasesButton = document.getElementById("total-cases-button")
    const totalDeathsButton = document.getElementById("total-deaths-button")

    totalCasesButton
      .addEventListener("click", function () {
        setTotalCasesStyle(1);
        setTotalDeathsStyle(0.0);
        toggleActiveButton('totalCases');
      });

    totalDeathsButton
      .addEventListener("click", function () {
        setTotalCasesStyle(0.0);
        setTotalDeathsStyle(1);
        toggleActiveButton('totalDeaths');
      });

    function toggleActiveButton(activeButton) {
      if (activeButton == 'totalCases') {
        totalCasesButton.classList.add('active')
        totalDeathsButton.classList.remove('active')
      } else {
        totalCasesButton.classList.remove('active')
        totalDeathsButton.classList.add('active')
      }
    }

    // Notify carto.Client that the layers exist. The client
    // is responsible for grouping layers into a single Leaflet layer.
    client.addLayer(totalCases);

    // Add layer to map
    client.getLeafletLayer().addTo(map);

  const popup = L.popup({ closeButton: false });
    totalCases.on(carto.layer.events.FEATURE_OVER, event => {
      popup.setLatLng(event.latLng);


      if (!popup.isOpen()) {
        var data = event.data;
        var content = "<div>";

        var keys = [
          "country",
          "total_cases",
          "total_deaths"
        ];

        content += `
          <h2 class="popup__title"> 
          ${data.country}
          </h2>
          <p class="popup__values">
          Total Cases: <span>${data.total_cases.toLocaleString('en-us')}</span><br />
          Total Deaths: <span>${data.total_deaths.toLocaleString('en-us')}</span>
          </p>
        `
        popup.setContent("" + content);
        popup.openOn(map);
      }
    });

    totalCases.on(carto.layer.events.FEATURE_OUT, event => {
      popup.removeFrom(map);
    });
  </script>
</body>

</html>