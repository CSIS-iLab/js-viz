<!DOCTYPE HTML>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>China Global Education Comparison</title>

		<link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,700" rel="stylesheet">

		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script src="https://code.highcharts.com/maps/highcharts.js"></script>
		<script src="https://code.highcharts.com/maps/modules/map.js"></script>
		<script src="https://code.highcharts.com/maps/modules/data.js"></script>
		<script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
		<script src="cn-all.js"></script>



		<style type="text/css">

			#container, #containerBar {
				height: 650px;
				min-width: 310px;
				max-width: 800px;
				margin: 0 auto;
			}
			.loading {
				margin-top: 10em;
				text-align: center;
				color: gray;
			}
			.legendTitle {
				font-weight:bold;
				font-style:italic;
				text-align:right;
				text-anchor: end;
			}
			.highcharts-legend-item text {
				cursor: default !important;
			}

		</style>

	</head>

<body>

	<script>

	$(function () {

		var barChart;
		var description; // Initialize indicator description variable. Will be populated when chart renders
		var currentIndicator = 'education';
		var legendTitle;
		var dataObj;
		var provinces = [];

		// Object associated text with indicators
		var indicatorsObj = {
			education: {
				buttonText: "Education Index",
				legendText: "Development Level",
				description: "Calculated from mean years of schooling and expected years of schooling. Rated from<br />0 (no educational attainment) to 1 (perfect educational attainment).<br />Source: UNDP",
				buttonX: 100,
				buttonY: 600,
				maxColor: null,
				reversed: false,
			},
	      	literacy: {
				buttonText: "Literacy",
				legendText: "Literacy Rate",
				description: "Percentage of the population 15+ years with the ability to read and write.<br />Source: China Statistical Yearbook, World Bank",
				buttonX: 215,
				buttonY: 600,
				reversed: false,
				stops: [
					[0, "#bcdeb6"],
					[0.5,"#85c1a1"],
					[.9, "#395243"]
				]
			},
	      	primary: {
				buttonText: "Primary Student-Teacher Ratio",
				legendText: "Student-Teacher Ratio",
				description: "Ratio of students who attend a primary educational institution divided by the number of teachers in the institution.<br />Source: China Statistical Yearbook, UNESCO",
				buttonX: 284,
				buttonY: 600,
				reversed: true,
				stops: [
					[0, "#fcf49f"],
					[0.5,"#ffd161"],
					[.9, "#8e7337"]
				]
			},
	      	secondary: {
				buttonText: "Secondary Student-Teacher Ratio",
				legendText: "Student-Teacher Ratio",
				description: "Ratio of students who attend a secondary educational institution divided by the number of teachers in the institution.<br />Source: China Statistical Yearbook, UNESCO",
				buttonX: 483,
				buttonY: 600,
				reversed: true,
				stops: [
					[0, "#fee499"],
					[0.5,"#ef9365"],
					[.9, "#88533a"]
				]
			},
	      	tertiary: {
				buttonText: "Tertiary Enrollment Share",
				legendText: "Enrollment Share",
				description: "Percentage of people enrolled in a tertiary institution out the entire college-age population.<br />Source: UNDP, World Bank",
				buttonX: 695,
				buttonY: 600,
				reversed: false,
				stops: [
					[0, "#edb2be"],
					[0.5,"#dd4760"],
					[.9, "#662230"]
				]
			},
		};

		var options = {
			data: {
				googleSpreadsheetKey: '1wjo9UVjnL2N22ukdwI5B4CC4RKLEbW3fqWNNCx-no_0',
				googleSpreadsheetWorksheet: 1,


			    // custom handler when the spreadsheet is parsed
			    parsed: function(columns) {

					// Read the columns into the data array
					var data = {
						education: [],
						literacy: [],
						primary: [],
						secondary: [],
						tertiary: [],
						educationBar: [],
						literacyBar: [],
						primaryBar: [],
						secondaryBar: [],
						tertiaryBar: []
					};
				    columns[0].forEach(function(code, i) {
				      	if (i != 0) {
				      		data.education.push({
				      			code: columns[1][i].toUpperCase(),
				      			value: parseFloat(columns[4][i]),
				      			name: columns[0][i],
				      			countryMatch: columns[3][i],
				      			educationIndex: parseFloat(columns[2][i])
				      		});

				      		data.educationBar.push(parseFloat(columns[2][i]));

				      		data.literacy.push({
				      			code: columns[1][i].toUpperCase(),
				      			name: columns[0][i],
				      			value: parseFloat(columns[5][i]),
				      			countryMatch: columns[6][i]
				      		});

				      		data.literacyBar.push(parseFloat(columns[5][i]));

				      		data.primary.push({
				      			code: columns[1][i].toUpperCase(),
				      			name: columns[0][i],
				      			value: parseFloat(columns[7][i]),
				      			countryMatch: columns[8][i]
				      		});

				      		data.primaryBar.push(parseFloat(columns[7][i]));

				      		data.secondary.push({
				      			code: columns[1][i].toUpperCase(),
				      			name: columns[0][i],
				      			value: parseFloat(columns[9][i]),
				      			countryMatch: columns[10][i]
				      		});

				      		data.secondaryBar.push(parseFloat(columns[9][i]));

				      		data.tertiary.push({
				      			code: columns[1][i].toUpperCase(),
				      			name: columns[0][i],
				      			value: parseFloat(columns[11][i]),
				      			countryMatch: columns[12][i]
				      		});

				      		data.tertiaryBar.push(parseFloat(columns[11][i]));
				      	}
				    });
			      	dataObj = data;
				}
			},

			chart: {
				borderWidth: 0,
				marginBottom: 60,
				events: {
					load: function() {
						this.series[0].setData(dataObj.education);
					}
				},
				style: {
                    fontFamily: 'Roboto Slab'
                }
			},
			exporting: {
				enabled: false
			},

			colors: ['#DD4760','#EF9365','#FFD160','#85C1A1'],
			//title of map
			title: {
				text: 'Provincial Education Breakdown in China',
				margin: 50,
				align: 'left'
			},

			// +/- zoom
			mapNavigation: {
				enabled: true,
				buttonOptions: {
					verticalAlign: "middle"
				}
			},

			credits: {
				enabled: true,
				text: 'CSIS China Power Project'
			},

			legend: {
				align: 'right',
				verticalAlign: 'top',
				floating: true,
				layout: 'horizontal',
				valueDecimals: 0,
				symbolRadius: 0,
				symbolHeight: 15
			},

		  	colorAxis: {
		  		dataClassColor: "category",
			  	labels: {
			  		enabled: true,
			  		formatter: function() {
			  			return this.value
			  		}
			  	},

			 	dataClasses: [{
                    from: 0,
                    to: 1,
                    name: 'Low<br />0.199-0.489',
                    color: '#DD4760'
                }, {
                    from: 1.1,
                    to: 2,
                    name: 'Medium<br />0.489 - 0.653',
                    color: '#EF9365'
                }, {
					from: 2.1,
					to: 3,
					name: 'High<br />0.653 - 0.767',
					color: '#FFD160'
				},
				{
					from: 3.1,
					to: 4,
					name: 'Very High<br />0.767 - 0.932',
					color: '#85C1A1'
				}]
			},

			tooltip: {
				useHTML: true,
				formatter: function() {
					if(currentIndicator == 'education') {
						value = this.point.educationIndex;
					}
					else {
						value = this.point.value;
					}
					return '<span style="font-weight:bold;text-decoration:underline;text-align:center;display:block;margin-bottom:-10px;">'+this.key+'</span><br /><strong>'+indicatorsObj[currentIndicator].buttonText+':</strong> '+value+'<br /><strong>Country Match:</strong> '+this.point.countryMatch;
				}
			},

			series: [{
			    mapData: Highcharts.maps['countries/cn/cn-all'],
			    joinBy: ['hc-a2', 'code'],
			    animation: true,
			    nullColor: '#4E6D78',
			    borderColor: '#ECECEC',
			    name: 'GDP Growth Rate',
			    states: {
			    	hover: {
			    		brightness: -0.2
			    	}
			    },
			    tooltip: {
			    	valueDecimals: 2,
			    	valueSuffix: '%'
			    }
			}]
		};

		function renderMap() {

			// Create the Bar Chart
			var optionsBar = {
			    chart: {
			      type: 'bar',
			      border: 'none',
			    },
			    credits: {
			      enabled: true,
			      text: "CSIS China Power Project"
			    },
			    title: {
			      text: "Provincial Education Breakdown in China"
			    },
			    colors: ['#DD4760','#EF9365','#FFD160','#85C1A1'],
			    xAxis: {
			        categories: ["Anhui", "Beijing", "Chongqing", "Fujian", "Gansu", "Guangdong", "Guangxi", "Guizhou", "Hainan", "Hebei", "Heilongjiang", "Henan", "Hubei", "Hunan", "Inner Mongolia", "Jiangsu", "Jiangxi", "Jilin", "Liaoning", "Ningxia", "Qinghai", "Shaanxi", "Shandong", "Shanghai", "Shanxi", "Sichuan", "Tianjin", "Tibet (Xizang)", "Xinjiang", "Yunnan", "Zhejiang"],
			        labels: {
			    		enabled: true,
                		step: 1,
			    	}
			    },
			    yAxis: {
			    	title: {
			    		text: "Test"
			    	},
			    	reversed: false,
			    	labels: {
			    		overflow: 'justify'
			    	}
			    },
			    plotOptions: {
			    	bar: {
		                dataLabels: {
		                    enabled: false,
		                    crop: false,
		                    overflow: 'none',
		                    allowOverlap: true
		                }
		            }
			    },
			    legend: {
			      align: 'center',
			      verticalAlign: 'bottom',
			      layout: 'horizontal'
			    },
			    series: [{
			    	name: indicatorsObj[currentIndicator].legendText,
			    	data: dataObj.educationBar
			    }]
			};
			barChart = Highcharts.chart('containerBar', optionsBar);

			console.log(dataObj.educationBar);

			// Render initial text
			description = chart.renderer.text(indicatorsObj[currentIndicator].description, 10, 50).attr({'id': "description"}).add();

			legendTitle = chart.renderer.text(indicatorsObj[currentIndicator].legendText, chart.plotWidth, 60).attr({'id': "legendTitle", 'class': "legendTitle"}).add();

			// Render Buttons
			$.each(indicatorsObj, function(key, value) {
				if(key == "education") {
					normalState = {id: "button_"+key, fill: "#E6E6E6"};
				}
				else {
					normalState = {id: "button_"+key};
				}
				chart.renderer.button(value.buttonText, value.buttonX, value.buttonY, function() {
					switchData(key);
				}, normalState).add();
			});

			// Disable Legend Click (Existing bug in highcharts)
	        $(".highcharts-legend-item text").click(function() {
	        	return false;
	        });

		}

		// Initiate the Map chart
		var chart = Highcharts.Map('container', options, renderMap);


        // Switch between datasets
        function switchData(indicator) {
        	$("#button_"+currentIndicator+" rect").css("fill", "#f7f7f7");
        	$("#button_"+indicator+" rect").css("fill", "#E6E6E6");

        	currentIndicator = indicator; // Update the current Indicator

        	// Update the Map
        	
        	if(indicator == "education") {
	        	chart.colorAxis[0].update({
	        		dataClasses: [{
	                    from: 0,
	                    to: 1,
	                    name: 'Low<br />0.199-0.489',
	                    color: '#DD4760'
	                }, {
	                    from: 1.1,
	                    to: 2,
	                    name: 'Medium<br />0.489 - 0.653',
	                    color: '#EF9365'
	                }, {
						from: 2.1,
						to: 3,
						name: 'High<br />0.653 - 0.767',
						color: '#FFD160'
					},
					{
						from: 3.1,
						to: 4,
						name: 'Very High<br />0.767 - 0.932',
						color: '#85C1A1'
					}],
					reversed: indicatorsObj[currentIndicator].reversed
	        	}, false);

	        	chart.legend.update();

				legendTitle.attr({text: indicatorsObj[currentIndicator].legendText, y: 60}); // Update the description text
	        }
	        else {
	        	chart.colorAxis[0].update({
	        		dataClasses: undefined,
	        		dataClassColor: "tween",
	        		stops: indicatorsObj[currentIndicator].stops,
	        		reversed: indicatorsObj[currentIndicator].reversed
	        	}, false);

	        	chart.legend.update();

				legendTitle.attr({text: indicatorsObj[currentIndicator].legendText, y: 70}); // Update the description text
	        }

        	chart.series[0].setData(dataObj[indicator], true); // Update the series data
           	description.attr({text: indicatorsObj[currentIndicator].description}); // Update the description text

           	// Update the Bar Chart
           	barChart.series[0].update({name: indicatorsObj[indicator].legendText}); // Update Series Name
           	barChart.series[0].setData(dataObj[currentIndicator+"Bar"], true); // Update the series data

           	console.log(indicator+"Bar");
           	console.log(dataObj[currentIndicator+"Bar"]);
           	console.log(dataObj);


        }

	});


	</script>

	<div id="container" style="max-width: 1000px"></div>
	<div id="containerBar" style="max-width: 1000px"></div>



</body>

</html>
