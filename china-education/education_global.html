<!DOCTYPE HTML>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>China Global Education Comparison</title>

		<link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,700" rel="stylesheet">

		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		  <script src="https://code.highcharts.com/maps/highmaps.js"></script>
		<script src="https://code.highcharts.com/maps/modules/data.js"></script>
		<script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
		<script src="cn-all.js"></script>



		<style type="text/css">

			#container {
				height: 500px;
				min-width: 310px;
				max-width: 800px;
				margin: 0 auto;
			}
			.loading {
				margin-top: 10em;
				text-align: center;
				color: gray;
			}
			.legendTitle {
				font-weight:bold;
				font-style:italic;
				text-align:right;
			}

		</style>

	</head>

<body>

	<script>

	$(function () {

		var description; // Initialize indicator description variable. Will be populated when chart renders
		var currentIndicator = 'education';
		var legendTitle;

		// Object associated text with indicators
		var indicatorsObj = {
			education: {
				buttonText: "Education Index",
				legendText: "Education Index Legend",
				buttonX: 200,
				buttonY: 80,
				maxColor: null,
				reversed: false,
			},
	      	literacy: {
				buttonText: "Literacy Rate",
				legendText: "Literacy Rate",
				buttonX: 320,
				buttonY: 80,
				maxColor: '#85C1A1',
				reversed: false,
			},
	      	primary: {
				buttonText: "Primary Ratio",
				legendText: "Primary Ratio",
				buttonX: 422,
				buttonY: 80,
				maxColor: '#FFD160',
				reversed: true,
			},
	      	secondary: {
				buttonText: "Secondary Ratio",
				legendText: "Secondary Ratio",
				buttonX: 528,
				buttonY: 80,
				maxColor: '#EF9365',
				reversed: true,
			},
	      	tertiary: {
				buttonText: "Tertiary Ratio",
				legendText: "Tertiary Ratio",
				buttonX: 645,
				buttonY: 80,
				maxColor: '#DD4760',
				reversed: false,
			},
		};

		var options = {
			data: {
				googleSpreadsheetKey: '1wjo9UVjnL2N22ukdwI5B4CC4RKLEbW3fqWNNCx-no_0',
				googleSpreadsheetWorksheet: 1,


			    // custom handler when the spreadsheet is parsed
			    parsed: function(columns) {

					// Read the columns into the data array
					var data = {
						education: [],
						literacy: [],
						primary: [],
						secondary: [],
						tertiary: []
					};
				    columns[0].forEach(function(code, i) {
				      	if (i != 0) {
				      		data.education.push({
				      			code: columns[1][i].toUpperCase(),
				      			value: parseFloat(columns[4][i]),
				      			name: columns[0][i],
				      			countryMatch: columns[3][i],
				      			educationIndex: parseFloat(columns[2][i])
				      		});

				      		data.literacy.push({
				      			code: columns[1][i].toUpperCase(),
				      			name: columns[0][i],
				      			value: parseFloat(columns[5][i]),
				      			countryMatch: columns[6][i]
				      		});

				      		data.primary.push({
				      			code: columns[1][i].toUpperCase(),
				      			name: columns[0][i],
				      			value: parseFloat(columns[7][i]),
				      			countryMatch: columns[8][i]
				      		});

				      		data.secondary.push({
				      			code: columns[1][i].toUpperCase(),
				      			name: columns[0][i],
				      			value: parseFloat(columns[9][i]),
				      			countryMatch: columns[10][i]
				      		});

				      		data.tertiary.push({
				      			code: columns[1][i].toUpperCase(),
				      			name: columns[0][i],
				      			value: parseFloat(columns[11][i]),
				      			countryMatch: columns[12][i]
				      		});
				      	}
				    });
			      	dataObj = data;
				}
			},

			chart: {
				borderWidth: 1,
				events: {
					load: function() {
						this.series[0].setData(dataObj.education);
					}
				},
				style: {
                    fontFamily: 'Roboto Slab'
                }
			},
			exporting: {
				allowHTML: true,
				buttons: {
					contextButton: {
						verticalAlign: "bottom"
					}
				}
			},

			plotOptions: {
				map: {
	                events: {
	                    legendItemClick: function (event) {
	                        return false; // <== returning false will cancel the default action
	                    }
	                }
			    }    		       
		    },

			colors: ['#DD4760','#EF9365','#FFD160','#85C1A1'],
			//title of map
			title: {
				text: 'China - Global Education Indicators Comparison',
				margin: 90,
				align: 'left'
			},

			// +/- zoom
			mapNavigation: {
				enabled: true,
				buttonOptions: {
					verticalAlign: "bottom"
				}
			},

			credits: {
				enabled: true,
				text: 'CSIS China Power Project'
			},

			legend: {
				align: 'right',
				verticalAlign: 'top',
				floating: true,
				layout: 'horizontal',
				valueDecimals: 0,
				symbolRadius: 0,
				symbolHeight: 15
			},

		  	colorAxis: {
		  		dataClassColor: "category",
			  	labels: {
			  		enabled: true,
			  		formatter: function() {
			  			return this.value
			  		}
			  	},

			 	dataClasses: [{
                    from: 0,
                    to: 1,
                    name: 'Low',
                    color: '#DD4760'
                }, {
                    from: 1.1,
                    to: 2,
                    name: 'Medium',
                    color: '#EF9365'
                }, {
					from: 2.1,
					to: 3,
					name: 'High',
					color: '#FFD160'
				},
				{
					from: 3.1,
					to: 4,
					name: 'Very High',
					color: '#85C1A1'
				}]
			},

			tooltip: {
				useHTML: true,
				formatter: function() {
					if(currentIndicator == 'education') {
						value = this.point.educationIndex;
					}
					else {
						value = this.point.value;
					}
					return `<span style="font-weight:bold;text-decoration:underline;text-align:center;display:block;margin-bottom:-10px;">${this.key}</span><br />
					<strong>${indicatorsObj[currentIndicator].buttonText}:</strong> ${value}<br />
					<strong>Country Match:</strong> ${this.point.countryMatch}`;
				}
			},

			series: [{
			    mapData: Highcharts.maps['countries/cn/cn-all'],
			    joinBy: ['hc-a2', 'code'],
			    animation: true,
			    nullColor: '#4E6D78',
			    name: 'GDP Growth Rate',
			    states: {
			    	hover: {
			    		brightness: -0.2
			    	}
			    },
			    tooltip: {
			    	valueDecimals: 2,
			    	valueSuffix: '%'
			    }
			}]
		};

		function renderButtons() {
			// Render initial text
			description = chart.renderer.text(indicatorsObj[currentIndicator].buttonText, 10, 50).attr({'id': "description"}).add();

			legendTitle = chart.renderer.text(indicatorsObj[currentIndicator].legendText, 850, 50).attr({'id': "legendTitle", 'class': "legendTitle"}).add();

			// Render Buttons
			$.each(indicatorsObj, function(key, value) {
				chart.renderer.button(value.buttonText, value.buttonX, value.buttonY, function() {
					switchData(key);
				},null,null,null).add();
			});

		}

		// Initiate the chart
		var chart = Highcharts.Map('container', options, renderButtons);


        // Switch between datasets
        function switchData(indicator) {
        	currentIndicator = indicator; // Update the current Indicator
        	
        	if(indicator == "education") {
	        	chart.colorAxis[0].update({
	        		dataClasses: [{
	                    from: 0,
	                    to: 1,
	                    name: 'Low',
	                    color: '#DD4760'
	                }, {
	                    from: 1.1,
	                    to: 2,
	                    name: 'Medium',
	                    color: '#EF9365'
	                }, {
						from: 2.1,
						to: 3,
						name: 'High',
						color: '#FFD160'
					},
					{
						from: 3.1,
						to: 4,
						name: 'Very High',
						color: '#85C1A1'
					}],
					reversed: indicatorsObj[currentIndicator].reversed
	        	}, false);

	        	chart.legend.update();

				legendTitle.attr({text: indicatorsObj[currentIndicator].legendText, y: 50}); // Update the description text
	        }
	        else {
	        	chart.colorAxis[0].update({
	        		dataClasses: undefined,
	        		dataClassColor: "tween",
	        		minColor: "#fdfdfd",
	        		maxColor: indicatorsObj[currentIndicator].maxColor,
	        		reversed: indicatorsObj[currentIndicator].reversed
	        	}, false);

	        	chart.legend.update();

				legendTitle.attr({text: indicatorsObj[currentIndicator].legendText, y: 70}); // Update the description text
	        }

        	chart.series[0].setData(dataObj[indicator], true); // Update the series data
           	description.attr({text: indicator}); // Update the description text
        }

	});


	</script>


	<div id="container" style="max-width: 1000px"></div>



</body>

</html>
